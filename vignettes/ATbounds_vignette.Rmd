---
title: "ATbounds: An R vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ATbounds: An R vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

___ATbounds___ is an R package that provides estimation and inference methods for bounding average treatment effects (on the treated) that are valid under an unconfoundedness assumption. The bounds are designed to be robust in challenging situations, for example, when the the conditioning variables take on a large number of different values in the observed sample, or when the overlap condition is violated. This robustness is achieved by only using limited "pooling" of information across observations. 

See Lee and Weidner (2021), "Bounding Treatment Effects by Pooling Limited Information across Observations," <arXiv:??? [econ.EM]>.

We begin by calling the ATbounds package.

```{r setup}
library(ATbounds)
```

# Bounding the Effects of a Job Training Program

To illustrate the usefulness of the package, we first use the well-known LaLonde dataset available at [Rajeev Dehejia's Data Page](http://users.nber.org/~rdehejia/nswdata2.html).

## LaLonde's Experimental Sample 

We fist look at LaLonde's original experimental sample. 

```{r}
  nsw_treated <- read.table("http://users.nber.org/~rdehejia/data/nsw_treated.txt")
  colnames(nsw_treated) <- c("treat","age","edu","black","hispanic",
                           "married","nodegree","RE75","RE78")

  nsw_control <- read.table("http://users.nber.org/~rdehejia/data/nsw_control.txt")
  colnames(nsw_control) <- c("treat","age","edu","black","hispanic",
                           "married","nodegree","RE75","RE78")

```

The outcome variable is `RE78` (earnings in 1978). The binary treatment indicator is `treat` (1 if treated, 0 if not treated). We now combine the treatment and control samples and define the variables.

```{r}
  nsw <- rbind(nsw_treated,nsw_control)
  attach(nsw)
  D <- treat  
  Y <- (RE78 > 0) 
```

In this vignette, we define the outcome to be whether employed in 1978 (that is, earnings in 1978 are positive). 

The LaLonde dataset is from the National Supported Work Demonstration (NSW), which is a randomized controlled temporary employment program. In view of that, we set the reference propensity score to be independent of covariates. 

```{r}
  rps <- rep(mean(D),length(D))  
```

The average treatment effect is obtained by 

```{r}
  ate_nsw <- mean(D*Y)/mean(D)-mean((1-D)*Y)/mean(1-D)
  print(ate_nsw)
```

Alternatively, we run simple regression

```{r}
  model <- lm(Y ~ D)
  summary(model)
  confint(model)
```

The 95% confidence interval $[0.01,0.14]$ is rather wide but excludes zero. 

## Dehejia-Wahba Sample 

Dehejia and Wahba (1999, 2002) extract a further subset of Lalonde's NSW experimental data to obtain a subset containing information on RE74 (earnings in 1974). 

```{r}
  detach(nsw)
  nswre_treated <- read.table("http://users.nber.org/~rdehejia/data/nswre74_treated.txt")
  colnames(nswre_treated) <- c("treat","age","edu","black","hispanic",
                           "married","nodegree","RE74","RE75","RE78")

  nswre_control <- read.table("http://users.nber.org/~rdehejia/data/nswre74_control.txt")
  colnames(nswre_control) <- c("treat","age","edu","black","hispanic",
                           "married","nodegree","RE74","RE75","RE78")
  nswre <- rbind(nswre_treated,nswre_control)
  attach(nswre)
  D <- treat  
  Y <- (RE78 > 0) 
  X <- cbind(age,edu,black,hispanic,married,nodegree,RE74/1000,RE75/1000)
```

The covariates are as follows:

* `age`: age in years,
* `edu`:  years of education,
* `black`: 1 if black, 0 otherwise, 
* `hispanic`: 1 if Hispanic, 0 otherwise, 
* `married`: 1 if married, 0 otherwise, 
* `nodegree`: 1 if no degree, 0 otherwise, 
* `RE74`: earnings in 1974, 
* `RE75`: earnings in 1975. 

If we assume that the Dehejia-Wahba sample still preserves initial randomization, we can
set the reference propensity score to be independent of covariates. However, it may not be the case and therefore, our approach can provide a robust method to check whether the Dehejia-Wahba sample can be viewed as a randomized controlled experiment. 

We first define the the reference propensity score.

```{r}
  rps <- rep(mean(D),length(D))  
```

Using this reference propensity score, the average treatment effect is obtained by 

```{r}
  ate_nswre <- mean(D*Y)/mean(D)-mean((1-D)*Y)/mean(1-D)
  print(ate_nswre)
```

Alternatively, we run simple regression

```{r}
  model <- lm(Y ~ D)
  summary(model)
  confint(model)
```

The resulting 95% confidence interval $[0.02,0.20]$ is wide but again excludes zero. 

### Bounds on ATE

We now introduce our bounds on the average treatment effect (ATE). 

```{r}
  bns_nsw <- atebounds(Y, D, X, rps)
```

In implementing `atebounds`, there are several options:

* `Q`: bandwidth parameter that determines the maximum number of observations for pooling information (default: $Q = 3$)

* `studentize`: `TRUE` if `X` is studentized elementwise and `FALSE` if not (default: `TRUE`)

* `alpha`: $(1-\alpha)$ nominal coverage probability for the confidence interval of ATE (default: 0.05)

* `discrete`: `TRUE` if `X` includes only discrete covariates and `FALSE` if not (default: `FALSE`)

* `n_hc`: number of hierarchical clusters to discretize non-discrete covariates; relevant only if x_discrete is FALSE. The default choice is `n_hc = ceiling(length(Y)/10)`, so that there are 10 observations in each cluster on average.

We show the summary results saved in `bns_nsw`.

```{r}
  summary(bns_nsw)
```

The 95% confidence interval $[-0.01,0.19]$ obtained here is similar to the previous interval $[0.02,0.20]$, which was obtained under the assumption that the Dehejia-Wahba sample is a random sample. This suggests that first, there is no evidence against violation of the random sampling assumption in the Dehejia-Wahba sample and second, our inference method does not suffer from unduly enlargement of the confidence interval to achieve robustness, although the estimate of null effect is now included in our confidence interval.

With $Q=2$, the bounds for ATE are
```{r}
summary(atebounds(Y, D, X, rps, Q = 2))
```

With $Q=4$, the bounds for ATE are
```{r}
summary(atebounds(Y, D, X, rps, Q = 4))
```


Recall that the point estimate of ATE under the random sampling assumption was

```{r}
print(ate_nswre)
```

Thus, the ATE estimate based on the simple mean difference weill within the 95% confidence intervals across $Q=2, 3, 4$. 

To check sensitivity to `n_hc`, that is the number of hierarchical clusters to discretize non-discrete covariates, we now run the following:

```{r}
summary(atebounds(Y, D, X, rps))
summary(atebounds(Y, D, X, rps, n_hc = ceiling(length(Y)/5)))
summary(atebounds(Y, D, X, rps, n_hc = ceiling(length(Y)/20)))
```

Recall that the default option for `n_hc` is `n_hc = ceiling(length(Y)/10)`. It can be seen that the alternative estimation result is more similar to the default one with `n_hc = ceiling(length(Y)/20)` than with `n_hc = ceiling(length(Y)/5)`. Overall, the results are qualitatively similar across the three different specifications of `n_hc`.  

Finally, to see what is saved in `bns_nsw`, we now print it out.

```{r}
  print(bns_nsw)
```

The output list contains: 

* `call`: a call in which all of the specified arguments are specified by their full names
* `type`: ATE
* `cov_prob`: confidence level (1-alpha)
* `y1_lb`: estimate of the lower bound on the average of $Y(1)$, i.e. $\mathbb{E}[Y(1)]$,
* `y1_ub`: estimate of the upper bound on the average of $Y(1)$, i.e. $\mathbb{E}[Y(1)]$,
* `y0_lb`: estimate of the lower bound on the average of $Y(0)$, i.e. $\mathbb{E}[Y(0)]$,
* `y0_ub`: estimate of the upper bound on the average of $Y(0)$, i.e. $\mathbb{E}[Y(0)]$,
* `est_lb`: estimate of the lower bound on ATE, i.e. $\mathbb{E}[Y(1) - Y(0)]$,
* `est_ub`: estimate of the upper bound on ATE, i.e. $\mathbb{E}[Y(1) - Y(0)]$,
* `est_rps`: the point estimate of ATE using the reference propensity score
* `se_lb`: standard error for the estimate on the lower bound on ATE
* `se_ub`: standard error for the estimate of the upper bound on ATE
* `ci_lb`: the lower end point of the confidence interval for ATE
* `ci_ub`: the upper end point of the confidence interval for ATE

### Bounds on ATT

We now look at bounds on the average treatment effect on the treated (ATT). 

```{r}
  bns_nsw_att <- attbounds(Y, D, X, rps)
  summary(bns_nsw_att)
```

We experiment with `Q`.

```{r}
  summary(attbounds(Y, D, X, rps, Q = 2))
```

```{r}
  summary(attbounds(Y, D, X, rps, Q = 4))
```

We also experiment with `n_hc`.

```{r}
summary(attbounds(Y, D, X, rps))
summary(attbounds(Y, D, X, rps, n_hc = ceiling(length(Y)/5)))
summary(attbounds(Y, D, X, rps, n_hc = ceiling(length(Y)/20)))
```

Bound estimates cross (that is, the lower bound is larger than the upper bound) and furthermore sensitive to the choice of `Q` and `n_hc`. This is likely to be driven by the relatively small sample size. However, once we factor into sampling uncertainty and look at the confidence intervals, all the results are more or less similar. 

## NSW treated plus PSID control 

The Dehejia-Wahba sample can be regarded as a data scenario where the propensity score is known and satisfies the overlap condition. We now turn to a different data scenario where it is likely that the propensity score is unknown and may not satisfy the overlap condition. 


```{r}
  psid2_control <- read.table("http://users.nber.org/~rdehejia/data/psid2_controls.txt")
  colnames(psid2_control) <- c("treat","age","edu","black","hispanic",
                           "married","nodegree","RE74","RE75","RE78")
  psid <- rbind(nswre_treated,psid2_control)
  detach(nswre)
  attach(psid)
  D <- treat  
  Y <- (RE78 > 0) 
  X <- cbind(age,edu,black,hispanic,married,nodegree,RE74/1000,RE75/1000)
```

Here, we use one of non-experimental comparison groups constructed by LaLonde from the Population Survey of Income Dynamics, namely PSID2 controls. We now estimate the reference propensity score using the sample proportion and obtain the new bound estimates:

```{r}
  rps_sp <- rep(mean(D),length(D))  
  bns_psid <- atebounds(Y, D, X, rps_sp)
  summary(bns_psid)
```

The confidence interval $[-0.35,0.31]$ here is much larger than the confidence interval $[-0.01,0.19]$ with the Dehejia-Wahba sample. It is worth noting that the sample proportion is unlikely to be correctly specified in the NSW treated plus PSID control sample. Thus, it seems that our inference method produces a wider confidence interval in order to be robust against misspecification of the propensity scores.     

We now consider the Manski bounds, which can be obtained by setting $Q = 1$. 

```{r}
  summary(atebounds(Y, D, X, rps_sp, Q=1))
```

We can see that the Manski bounds are even larger and the same regardless of the specification of the reference propensity scores. Recall the Manski bounds do not impose the unconfoundedness assumption and do not rely on any pooling information (hence, it does not matter how to specify the reference propensity score).   

Finally, we obtain the bounds for the average treatment effect on the treated (ATT).

```{r}
  summary(attbounds(Y, D, X, rps_sp))
  detach(psid)
```

We find that the bounds on ATT are wide, as in ATE.


# Bounding the Effect of Right Heart Catheterization 

As a second empirical example, we revisit the well-known Right Heart Catheterization Dataset available at [Vanderbilt Biostatistics Datasets Page](http://biostat.mc.vanderbilt.edu/wiki/Main/DataSets).
A cleaned version of the dataset is available in the package. 

```{r}
  Y <- RHC[,"survival"]
  D <- RHC[,"RHC"]
  X <- RHC[,-c(1,2)]
```

## Bounding the Average Treatment Effect 

We take the reference propensity score to be 
$\widehat{p}_{\text{RPS}}(X_i) = n^{-1} \sum_{i=1}^n D_i$
for each observation $i$. That is, we assign the sample proportion of the treated to the 
reference propensity scores uniformly for all observations. Of course, this is likely to be misspecified; however, it has the advantage that $1/\widehat{p}_{\text{RPS}}(X_i)$ is never close to 0 or 1.

```{r}
  rps <- rep(mean(D),length(D))  
```

We start with $Q=1$. 

```{r}
  summary(atebounds(Y, D, X, rps, Q = 1))
```

We now consider $Q=2$ 

```{r}
  summary(atebounds(Y, D, X, rps, Q = 2))
```

and $Q=3$. 

```{r}
  summary(atebounds(Y, D, X, rps, Q = 3))
```

Finally, we take $Q = 4$.

```{r}
  summary(atebounds(Y, D, X, rps, Q = 4))
```


## Bounding the Average Treatment Effect on the Treated

We now look at ATT with a few values of $Q$.

```{r}
  summary(attbounds(Y, D, X, rps, Q = 2))
  summary(attbounds(Y, D, X, rps, Q = 3))
  summary(attbounds(Y, D, X, rps, Q = 4))
  
```

